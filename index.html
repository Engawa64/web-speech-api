<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <link rel="stylesheet" href="style.css" />
    <title>ロシア語学習</title>
  </head>
  <style>
    .center-box {
      text-align: center;
    }
    .large-text {
      font-size: 4rem;
    }
  </style>
  <body>
    <h1>ロシア語勉強しよ！</h1>
    <p>ロシア語を入力してください。</p>
    <form id="form-ru" action="#">
      <input
        type="text"
        style="width: 520px; height: 100px;"
        value="Привет"
        id="input-message"
      />
    </form>
    <input type="button" onclick="showMessage()" value="▶︎決定" />
    <button id="speak">▶︎3回読み上げ</button>
    <button id="ex">▶︎サイトの説明</button>
    <p id="output-message"></p>
    <!---音声認識--->
    <p class="center-box"><img id="mic" src="micoff.svg" /></p>
    <div id="result-div" class="large-text"></div>
    <script>
      let text;
      /***テキストボックスに入力した文字を取得***/
      const showMessage = () => {
        const textbox = document.getElementById("input-message");
        const inputValue = textbox.value;

        //テキストボックスの文字を出力
        const output = "入力:" + inputValue;
        document.getElementById("output-message").innerHTML = output;
        text = document.getElementById("input-message").value;
        console.log(text);
      };

      //発話機能をインスタンス化
      let msg = new SpeechSynthesisUtterance();
      let voices = window.speechSynthesis.getVoices();
      let speakingtime = 0;
      //HTMLの要素を取得
      let button1 = document.querySelector("#speak");
      let button2 = document.querySelector("#ex");
      const resultDiv = document.querySelector("#result-div");
      const micDiv = document.querySelector("#mic");

      function speak(text) {
        // 以下オプション設定
        msg.volume = 1.0; // 音量 min 0 ~ max 1
        msg.rate = 1.0; // 速度 min 0.5 ~ max 3.5
        msg.pitch = 2.0; // 音程 min 0 ~ max 2
        msg.text = text; // 喋る内容
        msg.lang = "ru-RU";

        // 発話実行
        speechSynthesis.speak(msg);
      }

      // 終了時の処理
      msg.onend = function (event) {
        console.log("End: ", text);
      };

      /***ボタンをクリックした時***/
      //3回読み上げる
      button1.onclick = function () {
        for (let i = 0; i < 3; i++) {
          speak(text);
        }
      };
      //説明を表示する
      button2.onclick = function () {
        alert(
          "【読み上げ機能】\n①ロシア語を入力\n②決定を押す\n③読み上げを押すと3回読み上げられる\n\n【発音チェック】\n①マイクをオンにする\n②テキストボックスに入力した言葉を言う\n③上手く言えたらオウム返しされる。認識されなかったら聞き返される。"
        );
      };

      /***音声認識機能(Chrome)***/
      let rec = new webkitSpeechRecognition();
      let stopped = true;
      rec.continuous = true;
      rec.interimResults = false;
      rec.lang = "ru-RU";

      micDiv.onclick = function () {
        if (stopped == true) {
          stopped = false;
          resultDiv.innerHTML = "";
          rec.start();
        } else {
          stopped = true;
          rec.stop();
        }
      };

      rec.onstart = function () {
        console.log("on start");
        micDiv.setAttribute("src", "micon.svg");
        speakingtime = 0;
      };

      rec.onend = function () {
        console.log("on end");
        micDiv.setAttribute("src", "micoff.svg");
        if (stopped == false) {
          setTimeout(function () {
            rec.start();
          }, speakingtime());
        }
      };

      //マイクが音声を認識した時の処理
      rec.onresult = function (e) {
        rec.stop();
        for (let i = e.resultIndex; i < e.results.length; i++) {
          if (e.results[i].isFinal) {
            console.log(e);
            let russian = e.results[i][0].transcript;
            resultDiv.innerHTML = russian;
            russian = dialogue(russian);
            console.log(russian);
            speakingtime = text.length * 200;
            console.log("estimate:", speakingtime, "ms");
            speak(russian);
          }
        }
      };

      //練習：発音の判定(認識した音声が入力したテキストと一致するかどうか)
      function dialogue(input) {
        console.log("入力：" + text);
        console.log("発音：" + resultDiv.innerHTML);
        if ((resultDiv.innerHTML = text)) {
          return resultDiv.innerHTML;
        } else {
          return "Что Вы сказали?"; //意味：何とおっしゃいましたか？
        }
      }

      // 発話機能をインスタンス化
      let msgs = new SpeechSynthesisUtterance();

      function speak(russian) {
        msgs.volume = 1.0; // 音量 min 0 ~ max 1
        msgs.rate = 1.0; // 速度 min 0 ~ max 10
        msgs.pitch = 1.0; // 音程 min 0 ~ max 2
        msgs.text = russian; // 喋る内容
        msgs.lang = "ru-RU"; //ロシア語に設定

        // 発話実行
        speechSynthesis.speak(msgs);
      }

      // 終了時の処理
      msgs.onend = function (event) {
        console.log("END");
      };
    </script>
  </body>
</html>
